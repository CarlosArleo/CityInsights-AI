rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check ownership
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    match /projects/{projectId} {
      // Allow read/list only for the owner
      allow get: if isOwner(resource.data.ownerId);
      allow list: if isOwner(request.query.filters[0].value);
      
      // Allow create if the user is setting themselves as the owner
      allow create: if isOwner(request.resource.data.ownerId);
      
      // Allow update/delete for the owner
      allow update, delete: if isOwner(get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId);

      // Rules for sub-collections
      match /{path=**}/files/{fileId} {
        allow read, write, delete: if isOwner(get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId);
      }

      match /{path=**}/reviews/{reviewId} {
        allow read, write, delete: if isOwner(get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId);
      }
    }
  }
}
